#!/usr/bin/env python3
"""Install software."""

import subprocess
import sys
from pathlib import Path

# TODO: add argparse and options for installing.
# TODO: is it possible to write tests for this?

INSTALL_DIR = Path(__file__).parent.parent / "install"


def is_linux_distro(distro):
    try:
        output = subprocess.run(["lsb_release", "-is"], capture_output=True)
    except FileNotFoundError:
        return False
    if output.stdout.decode().lower() == distro.lower():
        return True
    return False


def is_installed(app):
    if subprocess.run(["command", "-v", app], capture_output=True).returncode == 0:
        return True
    return False


def install_with_apt():
    with open(INSTALL_DIR / "pkglist.txt", "r") as fp:
        pkgs = [line.strip() for line in fp.readlines()]
    for pkg in pkgs:
        subprocess.run(["sudo", "apt", "install", "-y", pkg])


def install_with_brew():
    subprocess.run(["brew", "bundle", "--file", INSTALL_DIR / "Brewfile"])


def install_with_code():
    with open(INSTALL_DIR / "extensions.txt", "r") as fp:
        exts = [line.strip() for line in fp.readlines()]
    for ext in exts:
        subprocess.run(["code", "--install-extension", ext])


def install_with_dnf():
    with open(INSTALL_DIR / "pkglist.txt", "r") as fp:
        pkgs = [line.strip() for line in fp.readlines()]
    for pkg in pkgs:
        subprocess.run(["sudo", "dnf", "install", "-y", pkg])


def install_with_nvim():
    path = Path("~/.local/share/nvim/site/autoload/plug.vim").expanduser()
    subprocess.run(
        [
            "sh",
            "-c",
            f"'curl -fLo {path} "
            "--create-dirs "
            "https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim'",
        ]
    )


def install_with_vim():
    path = Path("~/.vim/autoload/plug.vim").expanduser()
    subprocess.run(
        [
            "curl",
            "-fLo",
            path,
            "--create-dirs",
            "https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim",
        ]
    )


def install_brew():
    subprocess.run(
        [
            "/usr/bin/ruby",
            "-e",
            "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)",
        ]
    )
    subprocess.run(["brew", "update"])
    subprocess.run(["brew", "doctor"])


def install_fzf():
    path = Path("~/.fzf").expanduser()
    subprocess.run(
        [
            "git",
            "clone",
            "--depth",
            "1",
            "https://github.com/junegunn/fzf.git",
            path,
        ]
    )
    subprocess.run([path / "install"])


def install_starship():
    path = Path("~/bin").expanduser()
    if not path.exists():
        path.mkdir()
    TMPFILE = Path("tmp.sh")
    with open(TMPFILE, "w") as fp:
        subprocess.run(["curl", "-fsSL", "https://starship.rs/install.sh"], stdout=fp)
    subprocess.run(["chmod", "+x", TMPFILE])
    subprocess.run(["bash", TMPFILE, "--yes", f"--bin-dir={path}"])
    TMPFILE.unlink()


def configure_macos():
    subprocess.run(["bash", INSTALL_DIR / "mac.sh"])


def get_system():
    if sys.platform == "darwin":
        return "macos"
    elif sys.platform == "linux":
        if is_linux_distro("Ubuntu"):
            return "ubuntu"
        if is_linux_distro("Fedora"):
            return "fedora"
    else:
        raise RuntimeError("unsupported platform")


SYSTEM = get_system()

APPS = dict(
    macos=["brew", "fzf", "starship"],
    fedora=["fzf", "starship"],
    ubuntu=["fzf", "starship"],
)

INSTALLERS = dict(
    macos=["brew", "code"],
    fedora=["code", "dnf"],
    ubuntu=["apt", "code"],
)

CONFIGURE = dict(
    macos=configure_macos,
)

INSTALL_APP = dict(
    brew=install_brew,
    fzf=install_fzf,
    starship=install_starship,
)

INSTALL_WITH = dict(
    apt=install_with_apt,
    brew=install_with_brew,
    code=install_with_code,
    dnf=install_with_dnf,
    nvim=install_with_nvim,
    vim=install_with_vim,
)


def main():
    apps = APPS[SYSTEM]
    installers = INSTALLERS[SYSTEM]
    configure = CONFIGURE[SYSTEM]

    for app in apps:
        if not is_installed(app):
            INSTALL_APP[app]()

    for installer in installers:
        if is_installed(installer):
            INSTALL_WITH[installer]()

    configure()


if __name__ == "__main__":
    main()
